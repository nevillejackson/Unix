%
% Draft  document voiddocker.tex
%
 
\documentclass{article}  % Latex2e
\usepackage{graphicx,lscape,subfigure}
 

\title{Making a docker image to run the Waterfox browser}
\author{Neville Jackson}
\date{4 Sep 2022} 

\begin{document} 

\maketitle      

\section{Introduction} 
This project is about learning how to compose a Dockerfile which runs an X11 application. The Waterfox browser was chosen as an example X11 application, because Waterfox is not available as a package in most Linux distributions, so the result might actually be a useful means of obtaining Waterfox without having to download a tarfile and do a local install. 

Getting a running Docker container to talk to the X11 server in the host system is relatively easy. Waterfox is a large and complex X application, and most of the challenge of this project is in setting up in the Docker image a working environmejnt for Waterfox. 

\section{What is involved in a normal Waterfox install?}
There is a document~\cite{wate:22a} on that.  Briefly the steps are
\begin{enumerate}
\item Download a tarfile from the Waterfox website~\cite{wate:22} or from the Github site~\cite{wate:22b}.
\item  Unpack the tarfile in /usr/local/src
\begin{verbatim}
bzip2 -dc waterfox-G4.1.1.1.en-US.linux-x86_64.tar.bz2 | tar xvf -
\end{verbatim}
\item Make a link in /usr/local/bin to point to the Waterfox binary
\begin{verbatim}
ln /usr/local/src/waterfox/waterfox /usr/local/bin/waterfox
\end{verbatim}
\item Define the desktop icon by adding a file waterfox.desktop to the directory /usr/share applications. The file waterfox.desktop does not come with the tarfile, but is available here~\cite{wate:22a}
\end{enumerate}
We need to implement steps 1 to 3 in a Dockerfile. Step 4 can be omitted, as there will be no icon if running Waterfox in a container. The container will have to be started from the command line.

\section{How to run a docker container requiring access to the host Xserver}
We assume the host is running X11 ( not Wayland ). Set up the following primitive Dockerfile.
\begin{verbatim}
FROM debian
WORKDIR /home/demo
RUN apt-get -y update
RUN apt-get -y upgrade
RUN apt-get -y x11-apps
RUN groupadd -g 1000 demo
RUN useradd -d /home/demo -s /bin/bash -m demo -u 1000 -g 1000
USER demo
ENV HOME /home/demo
CMD /usr/bin/xcalc
\end{verbatim}
 Build this with 
\begin{verbatim}
docker build -t nevj/test:v2 .
Sending build context to Docker daemon  2.048kB
Step 1/10 : FROM debian
 ---> 07d9246c53a6
Step 2/10 : WORKDIR /home/demo
 ---> Running in 2e0e40e0fd4c
..........
Successfully built 517c1937106a
Successfully tagged nevj/test:v2
\end{verbatim}
 Then run it with
\begin{verbatim}
[nevj@trinity dtest]$ xhost +
[nevj@trinity dtest]$ docker run -v /tmp/.X11-unix:/tmp/.X11-unix \
          -e DISPLAY=$DISPLAY -h $HOSTNAME \
          -v $HOME/.Xauthority:/home/nevj/.Xauthority nevj/test:v2
\end{verbatim}
and the xcalc app appears in a separate X window, as shown in Figure~\ref{fig:xcalc}
\input{figxcalc.tex}
The {\em xhost +} statement is needed to give the container permission to communicate with the host X11 server. 
 The purpose of the options included in the {\em docker run} statement are as follows
\begin{description}
\item[-v /tmp/.X11-unix:/tmp/.X11-unix] defines a {\em mount} for a volume. The string {\em /tmp/.X11-unix:/tmp/.X11-unix} is the mount point on the host. The part before {\em ':'} is the volume name on the host. The part after {\em ':'} is where the file or directory is mounted oinside the container. A volume is just a file or directory in the host filesystem.
\item[-e DISPLAY=\$DISPLAY] sets the environment variable DISPLAY in the container
\item[-h \$HOSTNAME] sets the container hostname
\item[\$HOME/.Xauthority:/home/nevj/.Xauthority] sets the .Xauthority file of the container to the .Xauthority file of the host user who initiated the {\em run} statement again using a volume mount.
\item[nevj/test:v2] is the name of te image, build as above.
\end{description}
Volumes are the mechanism used by Docker containers to share data between the host and the container ( and between containers). They are need in this case because the container is an X11 client, while the host acts as the X11 server, so information has to pass between container and host.  A docker container can only write on the part of the host filesystem defined as a docker volume. There is also {\em tmpfs mount} which is a temporary ram disk used for non-permanent data within a container.

\section{First attempt at a Waterfox Dockerfile, using a  Debian parent image}
There is no new principle involved in running Waterfox rather than the simple xcalc app, in a docker container. The Waterfox browser is a large program with many dependencies, so the Dockerfile will have to build up a complete working environment specifically for Waterfox. 

I chose Debian parent image for a first attempt, because Debian is familiar and is most likely to compatable with Waterfox.  The Debian parent image is large. We shall try later to repeat the job with a smaller parent image. 

\subsection{Finding the dependencies of a binary program file}
There is a really good article~\cite{rehn:21} on identifying dependencies of a runtime binary when making a dockerfile.

If one looks at the unpacked Waterfox ditribution tarfile, it contains the files shon in Figure~\ref{fig:wfoxfiles}
\input{figwfoxfiles.tex}
The *.so files shown in green are dynamically loaded libraries. Presumably these are all dependencies of waterfox, but they may not be the only dependencies. There is a file TwemojiMozilla.ttf in the fonts subdirectory, and there are various default configuration files.

An initial check for dependencies can be obtained with {\em ldd}
\begin{verbatim}
nevj@mary:/usr/local/src/waterfox$ ldd waterfox
	linux-vdso.so.1 (0x00007ffc3eb95000)
	libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f2a6d46c000)
	libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f2a6d466000)
	libstdc++.so.6 => /lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007f2a6d299000)
	libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007f2a6d155000)
	libgcc_s.so.1 => /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f2a6d13b000)
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f2a6cf76000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f2a6d569000)
\end{verbatim}
This is best done in a Debian system in which waterfox has been installed
There are 8 libraries called directly by waterfox, and none of them are present in the distribution tarfile. These are libraries required for waterfox to start up. Note that linux-vdso.so.1 is a virtual library, ie it is built into the kernel and does not exist as a package. The other 7 should each be supplied by a package. We shall leave the problem of finding the package names which supply each library later.

 There may also be libraries which waterfoox loads dynamically while executing. To find these we do the following, again in a Debian system
\begin{verbatim}
nevj@mary:~$ LD_DEBUG=libs waterfox >&logfile

nevj@mary:~$ cat logfile
     2572:     find library=libpthread.so.0 [0]; searching
      2572:      search cache=/etc/ld.so.cache
      2572:       trying file=/lib/x86_64-linux-gnu/libpthread.so.0
      2572:
      2572:     find library=libdl.so.2 [0]; searching
      2572:      search cache=/etc/ld.so.cache
      2572:       trying file=/lib/x86_64-linux-gnu/libdl.so.2
      2572:
      2572:     find library=libstdc++.so.6 [0]; searching
      2572:      search cache=/etc/ld.so.cache
      2572:       trying file=/lib/x86_64-linux-gnu/libstdc++.so.6
      2572:
      2572:     find library=libm.so.6 [0]; searching
      2572:      search cache=/etc/ld.so.cache
      2572:       trying file=/lib/x86_64-linux-gnu/libm.so.6
      2572:
      2572:     find library=libgcc_s.so.1 [0]; searching
      2572:      search cache=/etc/ld.so.cache
      2572:       trying file=/lib/x86_64-linux-gnu/libgcc_s.so.1
     2572:
      2572:     find library=libc.so.6 [0]; searching
      2572:      search cache=/etc/ld.so.cache
      2572:       trying file=/lib/x86_64-linux-gnu/libc.so.6
      2572:
      2572:
      2572:     calling init: /lib/x86_64-linux-gnu/libpthread.so.0
      2572:
      2572:
      2572:     calling init: /lib/x86_64-linux-gnu/libc.so.6
      2572:
      2572:
      2572:     calling init: /lib/x86_64-linux-gnu/libgcc_s.so.1
      2572:
      2572:
      2572:     calling init: /lib/x86_64-linux-gnu/libm.so.6
      2572:
      2572:
      2572:     calling init: /lib/x86_64-linux-gnu/libstdc++.so.6
      2572:
      2572:
      2572:     calling init: /lib/x86_64-linux-gnu/libdl.so.2
      2572:
      2572:
      2572:     initialize program: waterfox
      2572:
      2572:
      2572:     transferring control: waterfox
      2572:
      2572:
      2572:     calling init: /usr/local/src/waterfox/libnspr4.so
      2572:
      2572:
      2572:     calling init: /usr/local/src/waterfox/libplc4.so
      2572:
      2572:
      2572:     calling init: /usr/local/src/waterfox/libplds4.so
      2572:
      2572:     find library=librt.so.1 [0]; searching
      2572:      search cache=/etc/ld.so.cache
      2572:       trying file=/lib/x86_64-linux-gnu/librt.so.1
      2572:
      2572:
      2572:     calling init: /lib/x86_64-linux-gnu/librt.so.1
      2572:
      2572:
      2572:     calling init: /usr/local/src/waterfox/libmozsandbox.so
      2572:
      2572:
      2572:     calling init: /usr/local/src/waterfox/liblgpllibs.so
      2572:
      2572:
      2572:     calling init: /usr/local/src/waterfox/libnssutil3.so
      2572:
      2572:
      2572:     calling init: /usr/local/src/waterfox/libnss3.so
      2572:
  ..................
     2796:     calling init: /lib/x86_64-linux-gnu/libX11-xcb.so.1
      2796:
      2796:
      2796:     calling init: /usr/local/src/waterfox/libxul.so
      2796:
      2796:     /usr/local/src/waterfox/waterfox: error: symbol lookup error:
 undefined symbol: nspr_use_zone_allocator (fatal)
      2796:
      2796:     calling init: /usr/local/src/waterfox/libsoftokn3.so
      2796:
      2796:
      2796:     calling init: /usr/local/src/waterfox/libfreeblpriv3.so
      2796:
JavaScript error: resource://gre/modules/PartitioningExceptionListService.jsm
, line 69: NS_ERROR_MALFORMED_URI: Component returned failure code: 0x804b000
a (NS_ERROR_MALFORMED_URI) [nsIPartitioningExceptionListObserver.onExceptionL
istUpdate]
console.error: PushService:
  clearOriginData: Error clearing origin data:
  TypeError
JavaScript error: resource:///modules/Interactions.jsm, line 209: NS_ERROR_FA
ILURE: Component returned failure code: 0x80004005 (NS_ERROR_FAILURE) [nsIUse
rIdleService.removeIdleObserver]

###!!! [Parent][RunMessage] Error: Channel closing: too late to send/recv, me
ssages will be lost
\end{verbatim}
Lots of messages, had to truncate it, was 5744 lines.
The first 3 lines say it is searching for a system library called {\em libpthread}. The lines beginning {\em calling init} indicate the library has been found and give its absolute path. Some libraries may not be found, and they will have no line beginning {\em calling init}. We can get a list of libraries found with 
\begin{verbatim}
nevj@mary:~$  cat out | grep init > outinit
nevj@mary:~$ wc outinit
  715  2878 45875 outinit
nevj@mary:~$  cat outinit
   2572:	calling init: /lib/x86_64-linux-gnu/libpthread.so.0
      2572:	calling init: /lib/x86_64-linux-gnu/libc.so.6
      2572:	calling init: /lib/x86_64-linux-gnu/libgcc_s.so.1
      2572:	calling init: /lib/x86_64-linux-gnu/libm.so.6
      2572:	calling init: /lib/x86_64-linux-gnu/libstdc++.so.6
      2572:	calling init: /lib/x86_64-linux-gnu/libdl.so.2
      2572:	initialize program: waterfox
      2572:	calling init: /usr/local/src/waterfox/libnspr4.so
      2572:	calling init: /usr/local/src/waterfox/libplc4.so
      2572:	calling init: /usr/local/src/waterfox/libplds4.so
      2572:	calling init: /lib/x86_64-linux-gnu/librt.so.1
      2572:	calling init: /usr/local/src/waterfox/libmozsandbox.so
      2572:	calling init: /usr/local/src/waterfox/liblgpllibs.so
      2572:	calling init: /usr/local/src/waterfox/libnssutil3.so
      2572:	calling init: /usr/local/src/waterfox/libnss3.so
      2572:	calling init: /usr/local/src/waterfox/libsmime3.so
      2572:	calling init: /usr/local/src/waterfox/libmozsqlite3.so
      2572:	calling init: /usr/local/src/waterfox/libssl3.so
      2572:	calling init: /lib/x86_64-linux-gnu/libgpg-error.so.0
  ............
\end{verbatim}
  
So there are still 715 of them. The first 6 are the startiup dependencies, and the rest are runtime dependencies

There is also the question of configuration files.



\begin{thebibliography}{99}

\bibitem{guru:99}
Docker tutorial.
URL https://www.guru99.com/docker-tutorial.html

\bibitem{dock:00}
Docker get started
URL https://docs.docker.com/get-started/

\bibitem{dock:01}
Docker Desktop
URL https://docs.docker.com/desktop/install/linux-install/

\bibitem{dock:02}
Docker Hub
URL https://hub.docker.com/

\bibitem{dock:03}
Official Dockerfile documnet
URL https://docs.docker.com/develop/develop-images/dockerfile\_best-practices/


\bibitem{dock:04}
Dockerfile Guide
URL https://medium.com/@BeNitinAgarwal/best-practices-for-working-with-dockerfil
es-fb2d22b78186

\bibitem{dock:05}
Docker Basics: How to use Dockerfiles
URL https://thenewstack.io/docker-basics-how-to-use-dockerfiles/

\bibitem{dock:06}
A Beginners Guide to Understanding and Building Docker Images
URL https://jfrog.com/knowledge-base/a-beginners-guide-to-understanding-and-building-docker-images/

\bibitem{dock:07}
Best practices for writing Dockerfiles
URL https://docs.docker.com/develop/develop-images/dockerfile\_best-practices/


\bibitem{dock:09}
Creating a Docke Image for your Application
URL https://www.stereolabs.com/docs/docker/creating-your-image/

\bibitem{dock:10}
Docker Containerization Cookbook‚Äù - Hot Recipes for Docker Automation
URL https://distrowatch.tradepub.com/free/w\_java39/prgm.cgi?a=1

\bibitem{void:01}
Void Linux Docker Images
URL https://github.com/void-linux/void-docker


\bibitem{libr:22}
LibreWolf source code website.
URL https://gitlab.com/librewolf-community/browser/source

\bibitem{rehn:21}
Rehn, A. (2021)
Identifying application runtime dependencies: A toolkit for identifying the runtime libraries and associated data that applications require in order to run correctly inside containers. 
URL https://unrealcontainers.com/blog/identifying-application-runtime-dependencies/

\bibitem{wate:22} 
Waterfox website. URL https://www.waterfox.net

\bibitem{wate:22a}
Install the Waterfox browser on a Linux system. URL https://github.com/nevillejackson/Unix/blob/main/waterfox/waterfox.pdf

\bibitem{wate:22b}
WaterfocCo Github site URL https://github.com/WaterfoxCo/Waterfox/releases

\end{thebibliography}
\end{document}
